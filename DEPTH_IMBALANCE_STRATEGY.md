# 深度不平衡策略（策略四）

## 策略概述

深度不平衡策略是一种基于订单簿第一档深度不平衡的市价交易策略。该策略通过监控买卖盘第一档的数量关系，在出现极端不平衡时建仓，并在市场回归平衡时平仓。

## 策略逻辑

### 建仓条件（同时满足）

1. **最小深度要求**：买盘或卖盘第一档数量至少有一方 ≥ 最小深度阈值（默认 100）
2. **不平衡倍数**：买盘或卖盘第一档数量的较大值 ≥ 较小值的 N 倍（默认 6 倍）

**建仓方向**：

- 如果买盘第一档 > 卖盘第一档 → 市价做多（BUY）
- 如果卖盘第一档 > 买盘第一档 → 市价做空（SELL）

**示例**：

- 买一量：110 BTC，卖一量：10 BTC
- 110 ≥ 100 ✓（满足最小深度）
- 110 / 10 = 11 ≥ 6 ✓（满足不平衡倍数）
- → 执行市价做多

### 平仓条件（满足任一）

1. **深度平衡触发**：
   - 多头持仓：当卖盘第一档 ≥ 买盘第一档 × 平仓阈值（默认 70%）
   - 空头持仓：当买盘第一档 ≥ 卖盘第一档 × 平仓阈值（默认 70%）
2. **止损触发**：持仓亏损 ≥ 止损限制（默认 0.03 USDT）

**示例**：

- 建仓时：买一量 110，卖一量 10（做多）
- 平仓触发：当卖一量 ≥ 110 × 0.7 = 77 时
- → 执行市价平仓

## 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# ===== 深度不平衡策略配置 =====

# 最小深度数量（例如 100 表示第一档至少要有 100 个币）
DEPTH_IMBALANCE_MIN_QTY=100

# 不平衡倍数（例如 6 表示一档要是另一档的 6 倍以上）
DEPTH_IMBALANCE_RATIO=6

# 平仓阈值比例（例如 0.7 表示 70%，当反向深度达到原深度的 70% 时平仓）
DEPTH_IMBALANCE_CLOSE_RATIO=0.7

# 止损限制（USDT）
DEPTH_IMBALANCE_LOSS_LIMIT=0.03

# 刷新间隔（毫秒）
DEPTH_IMBALANCE_REFRESH_INTERVAL_MS=1000

# 最大平仓滑点（百分比，例如 0.05 = 5%）
DEPTH_IMBALANCE_MAX_CLOSE_SLIPPAGE_PCT=0.05

# 最大日志条目数
DEPTH_IMBALANCE_MAX_LOG_ENTRIES=200
```

## 启动策略

```bash
bun run depth-imbalance
```

或者：

```bash
bun depth-imbalance.tsx
```

## 策略优势

1. **快速反应**：基于订单簿第一档，能够快速捕捉市场瞬时不平衡
2. **简单直观**：逻辑清晰，易于理解和调试
3. **明确出场**：有清晰的平仓条件，避免长时间持仓
4. **参数可调**：所有关键参数都可以通过环境变量灵活调整

## 策略风险

### 1. **高频误判风险** ⚠️ 严重

**问题**：订单簿第一档数据变化极快，可能出现：

- 大单挂撤单造成的虚假信号
- 订单簿短暂不平衡后立即恢复
- 高频建仓平仓导致大量手续费

**影响**：

- 每次交易至少吃 2 次手续费（开仓 + 平仓）
- Taker 手续费通常在 0.05%-0.075% 左右
- 如果频繁触发，手续费可能吞噬所有利润

**缓解措施**：

- 增大 `DEPTH_IMBALANCE_MIN_QTY`（例如 200-500）
- 增大 `DEPTH_IMBALANCE_RATIO`（例如 8-10 倍）
- 增大 `DEPTH_IMBALANCE_REFRESH_INTERVAL_MS`（例如 2000-5000ms）

### 2. **市价单滑点风险** ⚠️ 严重

**问题**：策略使用市价单建仓和平仓：

- 在深度不足时可能造成较大滑点
- 大额交易可能吃掉多档深度
- 波动剧烈时可能以极差价格成交

**影响**：

- 实际成交价可能远差于预期
- 即使方向正确也可能因滑点亏损

**缓解措施**：

- 减小 `TRADE_AMOUNT`（使用小额测试）
- 只在深度充足的主流交易对使用
- 考虑在建仓前检查多档深度总和

### 3. **瞬时波动风险** ⚠️ 中等

**问题**：

- 建仓后价格可能立即反向波动
- 深度不平衡可能是大单即将成交的信号（而非趋势开始）
- 市场可能在平仓阈值附近反复横跳

**影响**：

- 可能在最差点位成交
- 频繁触发止损

**缓解措施**：

- 设置合理的止损限制
- 监控实际盈亏，及时调整参数

### 4. **交易所限频风险** ⚠️ 中等

**问题**：

- 高频检查深度 + 市价下单可能触发限频（429 错误）
- 被限频后策略会暂停，可能错过平仓时机

**影响**：

- 持仓暴露在市场风险中
- 可能触发强制平仓逻辑

**缓解措施**：

- 已内置限频保护和强制平仓逻辑
- 建议 `DEPTH_IMBALANCE_REFRESH_INTERVAL_MS` ≥ 1000ms

### 5. **单边市风险** ⚠️ 中等

**问题**：

- 在强势单边市中，深度不平衡可能持续很久
- 反向深度可能一直无法达到平仓阈值
- 价格可能持续反向运动

**影响**：

- 可能长时间持有亏损仓位
- 依赖止损才能平仓

**缓解措施**：

- 设置较严格的止损（例如 0.02-0.05 USDT）
- 监控持仓时间，考虑添加最大持仓时间限制

### 6. **数据延迟风险** ⚠️ 低

**问题**：

- WebSocket 推送可能有延迟
- 本地判断和交易所实际状态可能不同步

**影响**：

- 判断时的深度数据可能已过时
- 实际成交时市场条件已改变

**缓解措施**：

- 使用可靠的交易所 WebSocket
- 接受一定的数据延迟，通过参数设置留出缓冲

### 7. **过度拟合风险** ⚠️ 低

**问题**：

- 参数可能在历史数据上表现良好，但未来失效
- 不同市场环境需要不同参数

**影响**：

- 策略在某些市场条件下失效

**缓解措施**：

- 在多种市场条件下测试
- 定期回顾和调整参数

## 策略适用场景

✅ **适合**：

- 流动性极好的主流交易对（BTC/USDT、ETH/USDT）
- 订单簿深度充足的市场（每档几百到几千个币）
- 小额资金测试和学习

❌ **不适合**：

- 流动性差的小币种
- 深度薄弱的交易对
- 大额资金交易（滑点过大）
- 期望稳定盈利的生产环境（风险高，手续费重）

## 建议的参数范围

| 参数        | 保守值    | 中性值    | 激进值    |
| ----------- | --------- | --------- | --------- |
| MIN_QTY     | 500       | 200       | 100       |
| RATIO       | 10x       | 6x        | 4x        |
| CLOSE_RATIO | 0.5 (50%) | 0.7 (70%) | 0.9 (90%) |
| LOSS_LIMIT  | 0.02 USDT | 0.05 USDT | 0.1 USDT  |
| REFRESH_MS  | 5000ms    | 2000ms    | 1000ms    |

**保守参数**：交易次数少，但信号更可靠  
**激进参数**：交易频繁，手续费高，假信号多

## 实盘建议

1. **先在测试网/小额测试**：强烈建议用最小交易量（0.001 BTC）先运行 24 小时观察
2. **监控手续费占比**：如果手续费 > 利润的 50%，说明策略频率过高
3. **设置严格止损**：由于使用市价单，务必设置止损保护
4. **选择合适交易对**：建议只用 BTC/USDT、ETH/USDT 等深度最好的交易对
5. **随时准备人工介入**：监控策略运行，发现异常立即停止

## 总结

深度不平衡策略是一个**高风险、高频、适合小额测试**的策略。它的核心假设是"深度不平衡预示短期价格变化"，但这个假设在实际市场中：

- ✅ 有时成立（大买单推动价格上涨）
- ❌ 经常失效（挂单撤单、虚假信号、深度不代表成交）

**最大的风险来自手续费和滑点**。由于全部使用市价单，每次完整交易（开仓+平仓）至少需要盈利 0.1%-0.15% 才能覆盖手续费成本。如果频繁交易但盈亏平平，最终会因手续费累积亏损。

**建议仅作为学习和测试用途**，不建议用于大额实盘交易。
